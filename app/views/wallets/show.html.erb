<h1 class="wallet-title text-center jello-horizontal"><%= @wallet.name %></h1>

<div class="container">
  <div class="d-flex justify-content-end">
    <%= link_to "Back to wallets", wallets_path, class: "btn btn-flat m-2 mb-5" %>
  </div>

  <div class="d-flex justify-content-between">
    <%= render "layouts/overview" %>
    <div class="card-holdings-quantity mb-4 ms-3" style="width: 50%;">
      <h2 class="card-title-spec p-3">Allocation</h2>
      <%= render "layouts/doughnut" %>
      <%# <%= pie_chart @wallet.operations.group(:avg_buy_price).count, donut: true, empty: "No data" %>
    </div>
  </div>

  <!-- New Section for Best and Worst Performers -->
  <div class="d-flex justify-content-between mb-4">
    <!-- Best Performer -->
    <div class="performer-card m-1" style="width: 49%;">
      <div class="card-body">
        <h5 class="card-title-spec text-center p-3 my-3">Best Performer</h5>
        <% if @best_performer %>
          <div class="d-flex justify-content-evenly">
            <p class="performer-card-text px-3 pb-3">
               <%= @best_performer[:operation].holding.name %>
            </p>
            <p class="performer-card-text">
              <span class="performer-color-up"><i class="fa-solid fa-caret-up"> </i><%= number_with_precision(@best_performer[:performance], precision: 2) %>%</span>
            </p>
          </div>
        <% else %>
          <p class="performer-card-text">No data available</p>
        <% end %>
      </div>
    </div>

    <!-- Worst Performer -->
    <div class="performer-card m-1" style="width: 49%;">
      <div class="card-body">
        <h5 class="card-title-spec text-center p-3 my-3">Worst Performer</h5>
        <% if @worst_performer %>
          <div class="d-flex justify-content-evenly">
            <p class="performer-card-text px-3 pb-3">
               <%= @worst_performer[:operation].holding.name %>
            </p>
            <p class="performer-card-text">
              <span class="performer-color-down"><i class="fa-solid fa-caret-down"></i><%= number_with_precision(@worst_performer[:performance], precision: 2) %>%</span>
            </p>
          </div>
        <% else %>
          <p class="performer-card-text">No data available</p>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Wallet Assets Display -->
  <div class="wallet-card-container wallet-card">
    <div class="wallet">
      <div class="d-flex justify-content-between mb-5">
        <h2 class="card-title-spec">Assets</h2>
        <div>
          <button type="button" class="btn btn-wallet" data-bs-toggle="modal" data-bs-target="#addOperationModal">
            Add new operation
          </button>
          <%= link_to "Edit Wallet Name", edit_wallet_path(@wallet), class: "btn btn-wallet", data: { bs_toggle: "modal", bs_target: "#nameOperationModal" }%>
        </div>
      </div>
      <div class="grid-header text-center">
        <div class="column">Name</div>
        <div class="column">Price</div>
        <div class="column">Avg. Buy Price</div>
        <div class="column">Quantity</div>
        <div class="column">Holdings</div>
        <div class="column">Actions</div>
      </div>

      <% @wallet.operations.each do |operation| %>
        <div class="grid-operation text-center">
          <div class="column ms-4 holdingname"><%= operation.holding.name %></div>
          <div class="column">R$ <%= number_with_precision(find_full_holding_info(operation.holding.abreviation)["PRICE"], precision: 2) %></div>
          <div class="column">R$ <%=number_with_precision(operation.avg_buy_price, precision: 2) %></div>
          <div class="column"><%= operation.quantity %></div>
          <div class="column holdingamount">R$ <%=number_with_precision(operation.avg_buy_price * operation.quantity, precision: 2) %></div>

          <div class="column actions mb-3">
            <%= link_to new_wallet_operation_path(@wallet), class: "btn btn-action btn-sm", data: { bs_toggle: "modal", bs_target: "#addOperationModal" } do %>
              <i class="fa-solid fa-plus"></i>
            <% end %>

           <%= link_to edit_operation_path(operation), class: "btn btn-action btn-sm", data: { bs_toggle: "modal", bs_target: "#editOperationModal" } do %>
              <i class="fa fa-edit"></i>
           <% end %>

            <%= link_to operation_path(operation), data: { turbo_method: :delete, turbo_confirm: "Are you sure?" }, class: "btn btn-action btn-sm" do %>
              <i class="fa fa-trash"></i>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- BOOTSTRAP MODALS: -->

<!-- Bootstrap Modal - Add New Operation -->
<div class="modal fade" id="addOperationModal" tabindex="-1" aria-labelledby="addOperationModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title wobble-ver-left" id="addOperationModalLabel">Add New Operation</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <%= render "onew", operation: Operation.new(wallet: @wallet) %>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap Modal - Edit Operation -->
<div class="modal fade" id="editOperationModal" tabindex="-1" aria-labelledby="editOperationModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title wobble-ver-left" id="editOperationModalLabel">Edit Operation</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <% if @operation %>
          <%= render "oedit", operation: @operation %>
        <% else %>
          <p>Operation not found.</p>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap Modal - Edit Wallet Name -->
<div class="modal fade" id="nameOperationModal" tabindex="-1" aria-labelledby="nameOperationModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title wobble-ver-left" id="nameOperationModalLabel">Edit Wallet Name</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <%= render "form", wallet: Wallet.find(params[:id])%>
      </div>
    </div>
  </div>
</div>
